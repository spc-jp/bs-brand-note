<!DOCTYPE html>
<html lang="ja" class="">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>BS Hitokoto | Brand Note連動・迷えるチームの処方箋</title>
  <meta name="description" content="叱りたいわけじゃない。ただ、前に進んでほしいだけ。BS Brand Noteと連動して、今効く一言を提案します。">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700;900&display=swap" rel="stylesheet">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: { sans: ['"Noto Sans JP"', 'sans-serif'] },
          colors: {
            brand: {
              50: '#eef6ff',
              100: '#dbeafe',
              200: '#bfdbfe',
              300: '#93c5fd',
              400: '#60a5fa',
              500: '#3b82f6',
              600: '#2563eb',
              700: '#1d4ed8',
              800: '#1e40af',
              900: '#1e3a8a',
              950: '#172554',
            },
            accent: { 500: '#22c55e' },
            dark: { bg: '#0b1220', card: '#111c33' }
          },
          animation: {
            blob: 'blob 10s infinite',
            fadeIn: 'fadeIn .6s ease-out forwards',
            pop: 'pop .4s cubic-bezier(.175,.885,.32,1.275) forwards',
            shine: 'shine 1.5s infinite',
            float: 'float 6s ease-in-out infinite',
          },
          keyframes: {
            blob: {
              '0%': { transform: 'translate(0px, 0px) scale(1)' },
              '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
              '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
              '100%': { transform: 'translate(0px, 0px) scale(1)' },
            },
            fadeIn: { '0%': { opacity: 0, transform: 'translateY(10px)' }, '100%': { opacity: 1, transform: 'translateY(0)' } },
            pop: { '0%': { opacity: 0, transform: 'scale(0.9)' }, '100%': { opacity: 1, transform: 'scale(1)' } },
            shine: { '100%': { transform: 'translateX(100%) skewX(12deg)' } },
            float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } }
          }
        }
      }
    }
  </script>

  <!-- Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <style>
    body { -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
    body.modal-open { overflow: hidden; }
    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    .dark ::-webkit-scrollbar-thumb { background: #334155; }
    
    /* Glassmorphism */
    .glass {
      background: rgba(255,255,255,.8);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(255,255,255,.6);
    }
    .dark .glass { 
      background: rgba(17,28,51,.7); 
      border: 1px solid rgba(255,255,255,.08); 
    }
    
    .share-card-bg { background: linear-gradient(135deg, #1d4ed8 0%, #22c55e 100%); }
    
    .input-error { 
      border-color: #ef4444 !important; 
      background-color: #fef2f2 !important; 
      animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both;
    }
    .dark .input-error { background-color: #450a0a !important; }

    /* Scene Tab Active Style */
    .scene-tab.active {
      background-color: #e2e8f0;
      color: #1e293b;
      font-weight: 700;
      border-color: #cbd5e1;
    }
    .dark .scene-tab.active {
      background-color: #334155;
      color: #f1f5f9;
      border-color: #475569;
    }

    @keyframes shake {
      10%, 90% { transform: translate3d(-1px, 0, 0); }
      20%, 80% { transform: translate3d(2px, 0, 0); }
      30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
      40%, 60% { transform: translate3d(4px, 0, 0); }
    }
  </style>
</head>

<body class="bg-slate-50 text-slate-800 dark:bg-dark-bg dark:text-slate-100 font-sans h-screen w-full flex flex-col transition-colors duration-300 overflow-hidden selection:bg-brand-200 selection:text-brand-900">

  <!-- Background Effects -->
  <div class="fixed inset-0 -z-10 overflow-hidden pointer-events-none">
    <div class="absolute top-0 left-0 w-full h-full bg-slate-50 dark:bg-dark-bg transition-colors duration-300"></div>
    <div class="absolute top-[-10%] left-[-10%] w-96 h-96 bg-brand-300/30 dark:bg-brand-900/20 rounded-full mix-blend-multiply dark:mix-blend-screen filter blur-[80px] opacity-70 animate-blob"></div>
    <div class="absolute top-[30%] right-[-10%] w-96 h-96 bg-emerald-300/25 dark:bg-emerald-500/15 rounded-full mix-blend-multiply dark:mix-blend-screen filter blur-[80px] opacity-70 animate-blob" style="animation-delay: 2s"></div>
    <div class="absolute bottom-[-10%] left-[20%] w-80 h-80 bg-purple-300/25 dark:bg-purple-900/20 rounded-full mix-blend-multiply dark:mix-blend-screen filter blur-[80px] opacity-60 animate-blob" style="animation-delay: 4s"></div>
  </div>

  <!-- Header -->
  <header class="fixed top-0 w-full z-40 glass shadow-sm transition-all duration-300">
    <div class="max-w-5xl mx-auto px-4 h-16 flex items-center justify-between">
      <button onclick="switchTab('home')" class="flex items-center gap-2.5 hover:opacity-80 transition-opacity text-left group">
        <div class="bg-gradient-to-br from-brand-600 to-emerald-500 text-white p-2 rounded-xl shadow-lg shadow-brand-500/20 group-active:scale-95 transition-transform">
          <i data-lucide="wand-2" class="w-5 h-5"></i>
        </div>
        <div>
          <div class="text-[10px] uppercase text-slate-400 dark:text-slate-500 font-bold tracking-wider">BS Brand Note 連動</div>
          <h1 class="text-lg md:text-xl font-black tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-brand-700 to-emerald-600 dark:from-brand-300 dark:to-emerald-300">
            BS Hitokoto
          </h1>
        </div>
      </button>

      <div class="flex items-center gap-2">
        <a id="brandNoteLinkTop" href="https://spc-jp.github.io/bs-brand-note/" target="_blank" rel="noopener"
           class="hidden md:inline-flex items-center gap-2 px-3 py-2 rounded-full bg-brand-50 text-brand-700 hover:bg-brand-100 dark:bg-brand-900/30 dark:text-brand-200 dark:hover:bg-brand-900/50 transition text-xs font-bold ring-1 ring-brand-100 dark:ring-brand-800">
          <i data-lucide="external-link" class="w-3.5 h-3.5"></i>
          Brand Note
        </a>

        <button onclick="openGuide()" class="p-2.5 rounded-full text-brand-700 bg-brand-50 hover:bg-brand-100 dark:bg-brand-900/30 dark:text-brand-200 dark:hover:bg-brand-900/50 transition ring-1 ring-brand-100 dark:ring-brand-800" aria-label="使い方ガイド">
          <i data-lucide="book-open" class="w-5 h-5"></i>
        </button>

        <button onclick="toggleTheme()" class="p-2.5 rounded-full text-slate-500 hover:bg-slate-100 dark:text-slate-300 dark:hover:bg-slate-800 transition" aria-label="テーマ切り替え">
          <i data-lucide="moon" class="w-5 h-5 dark:hidden"></i>
          <i data-lucide="sun" class="w-5 h-5 hidden dark:block"></i>
        </button>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="flex-grow pt-20 pb-28 overflow-y-auto overflow-x-hidden scroll-smooth" id="mainContainer">
    <div class="max-w-md md:max-w-5xl mx-auto px-4 space-y-8 min-h-[80vh]">

      <!-- HOME TAB -->
      <section id="tab-home" class="tab-content block space-y-6 animate-fadeIn">

        <div class="text-center space-y-2 py-6 md:py-10">
          <h2 class="text-2xl md:text-4xl font-black text-slate-900 dark:text-white tracking-tight">
            販売管理は<br class="md:hidden" /><span class="text-brand-600 dark:text-brand-400 relative inline-block">
              スタートライン。
              <span class="absolute bottom-1 left-0 w-full h-3 bg-brand-200/50 dark:bg-brand-700/50 -z-10 rounded-sm transform -rotate-1"></span>
            </span>
          </h2>
          <p class="text-sm md:text-base text-slate-500 dark:text-slate-400 mt-3 font-medium max-w-2xl mx-auto leading-relaxed">
            若手と一緒に、次の価値をつくる言葉。
          </p>
        </div>

        <div class="md:grid md:grid-cols-12 md:gap-8 md:items-start">

          <div class="md:col-span-7 lg:col-span-8 space-y-6">

            <div class="glass rounded-[2rem] p-6 md:p-8 shadow-xl shadow-brand-900/5 dark:shadow-none relative overflow-hidden group">
              <div class="absolute top-0 right-0 w-40 h-40 bg-gradient-to-br from-brand-500/10 to-transparent rounded-bl-full -mr-10 -mt-10 pointer-events-none transition-transform group-hover:scale-110 duration-700"></div>

              <div class="space-y-6 relative z-10">

                <!-- Context Input Area -->
                <div class="rounded-2xl border border-slate-200 dark:border-slate-700/50 bg-white/60 dark:bg-slate-800/60 p-5 space-y-3 shadow-sm hover:shadow-md transition-shadow">
                  <div class="flex items-center justify-between gap-2">
                    <div class="text-xs font-black text-slate-500 dark:text-slate-400 flex items-center gap-1.5 uppercase tracking-wide">
                      <i data-lucide="link" class="w-3.5 h-3.5 text-brand-500"></i>
                      Brand Note 連動
                    </div>
                    <a href="https://spc-jp.github.io/bs-brand-note/" target="_blank" rel="noopener"
                       class="text-[10px] font-bold text-brand-600 dark:text-brand-300 hover:underline inline-flex items-center gap-1 py-1 px-2 rounded-lg bg-brand-50 dark:bg-brand-900/30 transition">
                      ノートを開く
                      <i data-lucide="external-link" class="w-3 h-3"></i>
                    </a>
                  </div>

                  <div class="space-y-2">
                    <label class="text-xs font-bold text-slate-700 dark:text-slate-300">
                      会社の前提 <span class="text-slate-400 font-normal">（診断の精度を高めるコンテキスト）</span>
                    </label>
                    <textarea id="companyContext" rows="3"
                      class="w-full bg-white dark:bg-slate-900/50 border-2 border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-200 text-xs rounded-xl focus:ring-2 focus:ring-brand-500 focus:border-brand-500 block p-3 transition-all font-medium resize-none placeholder:text-slate-400 dark:placeholder:text-slate-600"
                      placeholder="例：顧客700件超。若手を育て、新サービス共創につなげたい。50〜60代中心で65歳定年。Googleマップの口コミも採用上重要。">販売管理が主軸。顧客700件超。データから新サービス共創につなげたい。採用はできるが2〜3年で離職しやすい。50〜60代中心で65歳定年。若手の育成と後継者育成が課題。</textarea>

                    <div class="flex items-center justify-end gap-2 pt-1">
                      <button onclick="saveContext()" class="text-[10px] font-bold px-3 py-1.5 rounded-full bg-slate-800 text-white dark:bg-slate-200 dark:text-slate-900 hover:opacity-80 transition inline-flex items-center gap-1.5 shadow-md active:scale-95">
                        <i data-lucide="save" class="w-3 h-3"></i>
                        保存
                      </button>
                    </div>
                  </div>
                </div>

                <!-- Input Step 1: Target -->
                <div class="space-y-3">
                  <label class="flex items-center gap-2 text-sm font-black text-slate-800 dark:text-slate-100">
                    <div class="w-6 h-6 rounded-full bg-brand-100 dark:bg-brand-900/50 text-brand-600 dark:text-brand-300 flex items-center justify-center text-xs">1</div>
                    対象（ポジション）
                  </label>
                  <div class="grid grid-cols-2 gap-3">
                    <label class="cursor-pointer group relative">
                      <input type="radio" name="level" value="new" class="peer hidden" checked>
                      <div class="py-3 px-4 rounded-xl border-2 border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800/50 text-center text-sm font-bold text-slate-500 dark:text-slate-400 peer-checked:border-brand-500 peer-checked:bg-brand-50 dark:peer-checked:bg-brand-900/30 peer-checked:text-brand-700 dark:peer-checked:text-brand-200 transition-all shadow-sm group-active:scale-[0.98]">
                        <span class="block text-2xl mb-1 filter grayscale peer-checked:grayscale-0 transition-all">🐣</span> 新人・若手
                      </div>
                      <div class="absolute top-2 right-2 text-brand-500 opacity-0 peer-checked:opacity-100 transition-opacity">
                        <i data-lucide="check-circle-2" class="w-4 h-4 fill-brand-500 text-white"></i>
                      </div>
                    </label>
                    <label class="cursor-pointer group relative">
                      <input type="radio" name="level" value="mid" class="peer hidden">
                      <div class="py-3 px-4 rounded-xl border-2 border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800/50 text-center text-sm font-bold text-slate-500 dark:text-slate-400 peer-checked:border-brand-500 peer-checked:bg-brand-50 dark:peer-checked:bg-brand-900/30 peer-checked:text-brand-700 dark:peer-checked:text-brand-200 transition-all shadow-sm group-active:scale-[0.98]">
                        <span class="block text-2xl mb-1 filter grayscale peer-checked:grayscale-0 transition-all">🦅</span> 中堅・リーダー
                      </div>
                      <div class="absolute top-2 right-2 text-brand-500 opacity-0 peer-checked:opacity-100 transition-opacity">
                        <i data-lucide="check-circle-2" class="w-4 h-4 fill-brand-500 text-white"></i>
                      </div>
                    </label>
                  </div>
                </div>

                <!-- Input Step 2: Symptom -->
                <div class="space-y-3">
                  <label class="flex items-center gap-2 text-sm font-black text-slate-800 dark:text-slate-100">
                    <div class="w-6 h-6 rounded-full bg-brand-100 dark:bg-brand-900/50 text-brand-600 dark:text-brand-300 flex items-center justify-center text-xs">2</div>
                    気になる症状
                  </label>

                  <div class="relative group">
                    <select id="behavior" onchange="clearError()"
                      class="w-full bg-white dark:bg-slate-800/80 border-2 border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-200 text-sm rounded-xl focus:ring-2 focus:ring-brand-500 focus:border-brand-500 block p-4 appearance-none transition-all font-bold cursor-pointer hover:border-brand-300 dark:hover:border-slate-600">
                      <option value="" disabled selected>いちばん困っている場面を選んでください...</option>
                      <optgroup label="行動・姿勢">
                        <option value="task-only">言われた範囲で止まっている（指示待ち）</option>
                        <option value="no-decision">正解を探して決められない（判断依存）</option>
                        <option value="solo-play">一人で抱え込む（SOSが出せない）</option>
                        <option value="status-quo">変化を嫌う・現状維持バイアス</option>
                      </optgroup>
                      <optgroup label="コミュニケーション">
                        <option value="no-consult">相談なしで突っ走る（独走）</option>
                        <option value="silent">指摘すると黙り込む（フリーズ）</option>
                        <option value="late-report">悪い報告を隠す・遅れる</option>
                        <option value="critic">理屈はいいが動かない（評論家）</option>
                      </optgroup>
                      <optgroup label="マインド">
                        <option value="busy-word">「忙しい」と言い訳する</option>
                        <option value="perfectionist">完璧主義で遅い</option>
                        <option value="chicken-heart">失敗を恐れて足が止まる（正解主義）</option>
                      </optgroup>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-slate-500 group-hover:text-brand-600 transition-colors">
                      <i data-lucide="chevron-down" class="w-5 h-5"></i>
                    </div>
                  </div>

                  <div id="errorMsg" class="hidden flex items-center gap-1.5 text-xs text-red-500 font-black ml-1 animate-pulse">
                    <i data-lucide="alert-circle" class="w-3.5 h-3.5"></i>
                    <span>症状を選んでください</span>
                  </div>

                  <p class="text-xs text-slate-400 dark:text-slate-500 ml-1 leading-tight flex items-center gap-1">
                    <i data-lucide="info" class="w-3 h-3"></i>
                    迷いが強い場面を一つだけ選ぶのがコツです。
                  </p>
                </div>

                <!-- Action Button -->
                <div class="pt-4">
                  <button onclick="runDiagnosis()" id="diagnoseBtn"
                    class="w-full bg-gradient-to-r from-brand-600 to-emerald-500 hover:from-brand-500 hover:to-emerald-400 text-white font-black py-4 px-6 rounded-2xl shadow-xl shadow-brand-500/30 transform transition-all active:scale-[0.98] flex items-center justify-center gap-2 group relative overflow-hidden disabled:opacity-70 disabled:cursor-not-allowed border-b-4 border-brand-800/20 active:border-b-0 active:translate-y-1">
                    <div class="absolute inset-0 w-full h-full bg-white/20 translate-x-[-100%] skew-x-12 group-hover:animate-shine"></div>
                    <i data-lucide="sparkles" class="w-5 h-5 animate-pulse icon-normal"></i>
                    <span class="text-normal text-lg tracking-wide">処方箋を作成（Hitokoto）</span>
                    <span class="text-loading hidden flex items-center gap-2">
                      <i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i> 調合中...
                    </span>
                  </button>
                </div>

              </div>
            </div>

          </div>

          <!-- Sidebar -->
          <div class="md:col-span-5 lg:col-span-4 space-y-6 mt-8 md:mt-0">

            <!-- History Teaser -->
            <div id="homeHistoryTeaser" class="hidden animate-fadeIn bg-white/60 dark:bg-slate-800/60 p-5 rounded-[2rem] border border-slate-200 dark:border-slate-700/50 shadow-sm">
              <div class="flex items-center justify-between px-1 mb-4">
                <h3 class="text-xs font-black text-slate-400 uppercase tracking-wider flex items-center gap-1">
                  <i data-lucide="clock" class="w-3 h-3"></i> 最近の履歴
                </h3>
                <button onclick="switchTab('history')" class="text-xs text-brand-600 dark:text-brand-400 font-bold hover:underline">すべて見る</button>
              </div>
              <div id="teaserList" class="space-y-3"></div>
            </div>

            <!-- Tips -->
            <div class="py-8 px-6 text-center w-full rounded-[2rem] border-2 border-dashed border-slate-200 dark:border-slate-700/60 bg-slate-50/50 dark:bg-slate-800/30">
              <div class="w-10 h-10 bg-slate-200 dark:bg-slate-700 rounded-full flex items-center justify-center mx-auto mb-3 text-slate-400">
                <i data-lucide="lightbulb" class="w-5 h-5"></i>
              </div>
              <h4 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">使い方のコツ</h4>
              <p class="text-xs text-slate-500 dark:text-slate-400 leading-relaxed font-medium">
                正解を出すアプリではありません。<br>
                今の関係性で、摩擦が少ない<br>
                <span class="text-brand-600 dark:text-brand-300 font-bold">「次の一手」</span>を見つける相棒です。
              </p>

              <div class="mt-5">
                <a href="https://spc-jp.github.io/bs-brand-note/" target="_blank" rel="noopener"
                   class="inline-flex items-center justify-center gap-2 px-5 py-3 rounded-xl bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300 hover:text-brand-600 dark:hover:text-brand-300 hover:border-brand-200 dark:hover:border-brand-800 transition text-xs font-black w-full shadow-sm hover:shadow-md">
                  <i data-lucide="file-text" class="w-4 h-4"></i>
                  Brand Noteへ戻る（迷ったらここ）
                </a>
              </div>
            </div>

          </div>

        </div>

      </section>

      <!-- HISTORY TAB -->
      <section id="tab-history" class="tab-content hidden space-y-4 animate-fadeIn">
        <div class="flex items-center justify-between px-2">
          <h2 class="text-2xl font-black dark:text-white flex items-center gap-2">
            <i data-lucide="history" class="w-6 h-6 text-slate-300"></i>
            診断履歴
          </h2>
        </div>
        <div id="historyList" class="space-y-3 md:space-y-0 md:grid md:grid-cols-2 lg:grid-cols-3 md:gap-4 pb-20"></div>
      </section>

      <!-- FAVORITES TAB -->
      <section id="tab-favorites" class="tab-content hidden space-y-4 animate-fadeIn">
        <div class="flex items-center justify-between px-2">
          <h2 class="text-2xl font-black dark:text-white flex items-center gap-2">
            <i data-lucide="bookmark" class="w-6 h-6 text-slate-300"></i>
            保存済
          </h2>
        </div>
        <div id="favList" class="space-y-3 md:space-y-0 md:grid md:grid-cols-2 lg:grid-cols-3 md:gap-4 pb-20"></div>
      </section>

      <!-- Footer Copyright -->
      <div class="text-center py-6 text-[10px] text-slate-300 dark:text-slate-600 font-medium select-none">
        テスト版（ベータ版） &copy; 2026 SPC
      </div>

    </div>
  </main>

  <!-- GUIDE MODAL -->
  <div id="guideModal" class="fixed inset-0 z-[60] hidden">
    <div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm" id="guideBackdrop" onclick="closeGuide()"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="bg-white dark:bg-slate-900 w-full max-w-sm rounded-[2rem] shadow-2xl overflow-hidden transform scale-95 transition-all duration-300 border border-white/20" id="guidePanel">
        <div class="bg-brand-50 dark:bg-brand-900/20 p-8 text-center border-b border-brand-100 dark:border-brand-800/60 relative overflow-hidden">
          <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-brand-400 to-emerald-400"></div>
          <div class="w-14 h-14 bg-white dark:bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg shadow-brand-500/10 animate-float">
            <span class="text-3xl">🔰</span>
          </div>
          <h3 class="text-xl font-black text-slate-800 dark:text-white">BS Hitokoto へようこそ</h3>
          <p class="text-xs text-brand-600 dark:text-brand-300 mt-2 font-bold uppercase tracking-wider">Brand Noteとセットで効く相棒</p>
        </div>

        <div class="p-8 space-y-6">
          <p class="text-sm text-slate-600 dark:text-slate-300 leading-relaxed text-center font-medium">
            症状を一つ選ぶだけで、<br>
            今の関係性で摩擦が少ない「次の一言」を提案します。
          </p>

          <div class="space-y-4">
            <div class="flex gap-4 items-start">
              <div class="w-8 h-8 rounded-full bg-brand-100 dark:bg-brand-900/40 text-brand-600 dark:text-brand-300 flex items-center justify-center shrink-0 font-black text-sm mt-0.5">1</div>
              <div>
                <div class="text-sm font-black text-slate-800 dark:text-white">対象を選ぶ</div>
                <div class="text-xs text-slate-500 dark:text-slate-400 mt-0.5">新人・若手 / 中堅・リーダー</div>
              </div>
            </div>

            <div class="flex gap-4 items-start">
              <div class="w-8 h-8 rounded-full bg-brand-100 dark:bg-brand-900/40 text-brand-600 dark:text-brand-300 flex items-center justify-center shrink-0 font-black text-sm mt-0.5">2</div>
              <div>
                <div class="text-sm font-black text-slate-800 dark:text-white">症状を一つ選ぶ</div>
                <div class="text-xs text-slate-500 dark:text-slate-400 mt-0.5">いちばん困っている行動から</div>
              </div>
            </div>

            <div class="flex gap-4 items-start">
              <div class="w-8 h-8 rounded-full bg-brand-100 dark:bg-brand-900/40 text-brand-600 dark:text-brand-300 flex items-center justify-center shrink-0 font-black text-sm mt-0.5">3</div>
              <div>
                <div class="text-sm font-black text-slate-800 dark:text-white">処方箋を使う</div>
                <div class="text-xs text-slate-500 dark:text-slate-400 mt-0.5">言い方を変えると、前に進む</div>
              </div>
            </div>
          </div>

          <button onclick="closeGuide()" class="w-full bg-slate-900 dark:bg-white text-white dark:text-slate-900 font-black py-3.5 rounded-xl hover:opacity-90 transition shadow-lg active:scale-95">
            はじめる
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- RESULT MODAL -->
  <div id="resultModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4">
    <div class="absolute inset-0 bg-slate-900/70 backdrop-blur-sm transition-opacity opacity-0" id="resultBackdrop" onclick="closeModal()"></div>

    <div class="relative w-full max-w-2xl max-h-[92vh] bg-slate-50 dark:bg-slate-900 rounded-[2rem] shadow-2xl flex flex-col transform transition-all duration-300 scale-95 opacity-0 border border-white/10" id="resultPanel">
      
      <!-- Modal Header -->
      <div class="shrink-0 p-4 pl-6 flex items-center justify-between border-b border-slate-100 dark:border-slate-800">
        <div class="flex items-center gap-2.5">
          <div class="w-8 h-8 rounded-full bg-gradient-to-br from-brand-100 to-emerald-100 dark:from-brand-900/50 dark:to-emerald-900/50 flex items-center justify-center text-brand-600 dark:text-brand-300">
            <i data-lucide="sparkles" class="w-4 h-4"></i>
          </div>
          <span class="font-black text-slate-700 dark:text-slate-200 text-sm tracking-wide">BS Hitokoto Prescription</span>
        </div>
        <button onclick="closeModal()" class="w-9 h-9 flex items-center justify-center rounded-full bg-slate-100 dark:bg-slate-800 text-slate-500 hover:bg-slate-200 dark:hover:bg-slate-700 transition">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>

      <!-- Modal Content -->
      <div class="flex-grow overflow-y-auto p-6 space-y-6">
        
        <!-- Share Card -->
        <div id="shareCard" class="relative overflow-hidden rounded-3xl shadow-xl shadow-blue-500/20 group select-none transition-transform hover:scale-[1.01]">
          <div class="absolute inset-0 share-card-bg"></div>
          <!-- Card Deco -->
          <div class="absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2"></div>
          <div class="absolute bottom-0 left-0 w-48 h-48 bg-black/10 rounded-full blur-2xl translate-y-1/2 -translate-x-1/2"></div>
          <div class="absolute inset-0 bg-gradient-to-t from-black/10 to-transparent"></div>

          <div class="relative z-10 p-8 text-white text-center flex flex-col items-center justify-center min-h-[260px]">
            <div class="mb-5">
              <span id="resBadge" class="px-3 py-1 bg-white/20 backdrop-blur-md rounded-full text-[10px] font-black border border-white/30 tracking-widest shadow-sm">TYPE</span>
            </div>
            <i data-lucide="quote" class="w-8 h-8 text-white/40 mb-3"></i>
            <h2 id="resProverb" class="text-2xl md:text-3xl font-black leading-snug mb-8 drop-shadow-lg text-white font-feature-settings-palt"></h2>
            
            <div class="flex items-center justify-center gap-3 w-full opacity-80">
              <div class="h-px bg-white/40 flex-1 max-w-[40px]"></div>
              <p class="text-[10px] font-bold uppercase tracking-[0.2em]">BS Hitokoto</p>
              <div class="h-px bg-white/40 flex-1 max-w-[40px]"></div>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="grid grid-cols-2 gap-3">
          <button onclick="toggleCurrentFav()" id="saveFavBtn"
            class="flex items-center justify-center gap-2 py-3.5 rounded-xl border border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-200 font-bold hover:bg-slate-50 dark:hover:bg-slate-800 transition shadow-sm active:scale-[0.98]">
            <i data-lucide="bookmark" class="w-4 h-4"></i>
            <span>保存</span>
          </button>
          <button onclick="shareResult()" id="shareBtn"
            class="flex items-center justify-center gap-2 py-3.5 rounded-xl bg-slate-900 dark:bg-white text-white dark:text-slate-900 font-bold hover:opacity-90 transition shadow-lg shadow-slate-500/20 active:scale-[0.98]">
            <i data-lucide="share-2" class="w-4 h-4"></i>
            <span>シェア</span>
          </button>
        </div>

        <div class="space-y-4">
          
          <!-- Context Box (Dynamic) -->
          <div id="resContextBox" class="hidden bg-slate-50 dark:bg-slate-800/80 p-5 rounded-2xl border border-slate-200 dark:border-slate-700">
            <h3 class="flex items-center gap-2 text-xs font-black text-slate-400 uppercase tracking-wider mb-2">
              <i data-lucide="building-2" class="w-3.5 h-3.5"></i>
              前提条件
            </h3>
            <p id="resContextText" class="text-sm text-slate-600 dark:text-slate-300 font-medium"></p>
          </div>

          <!-- Explanation -->
          <div class="bg-white dark:bg-dark-card p-6 rounded-2xl border border-slate-100 dark:border-slate-800 shadow-sm">
            <h3 class="flex items-center gap-2 font-black text-slate-800 dark:text-white mb-3 text-lg">
              <span class="w-1 h-5 bg-brand-500 rounded-full"></span>
              <span id="resExplainTitle">処方箋の解説</span>
            </h3>
            <p id="resExplain" class="text-sm text-slate-600 dark:text-slate-300 leading-relaxed font-medium"></p>
          </div>

          <!-- Boss Voice Section (Added) -->
          <div class="bg-slate-50 dark:bg-slate-800/50 p-6 rounded-2xl border border-slate-200 dark:border-slate-700">
            <div class="mb-4">
              <h3 class="flex items-center gap-2 font-bold text-slate-700 dark:text-slate-200 text-sm">
                <i data-lucide="user-circle-2" class="w-4 h-4 text-brand-500"></i>
                社長のひとこと（シーン別）
              </h3>
              <p class="text-[10px] text-slate-400 dark:text-slate-500 mt-1 font-medium">
                同じ内容でも、言い方で伝わり方が変わります。場面に合わせて選んでください。
              </p>
            </div>

            <!-- Scene Tabs -->
            <div class="flex flex-wrap gap-2 mb-4" id="bossSceneTabs"></div>

            <!-- Voice List -->
            <ul id="resBossVoice" class="space-y-2.5"></ul>
          </div>

          <!-- Action List -->
          <div class="bg-gradient-to-br from-brand-50 to-emerald-50 dark:from-brand-900/20 dark:to-emerald-900/20 p-6 rounded-2xl border border-brand-100 dark:border-brand-800/50">
            <h3 class="flex items-center gap-2 font-black text-brand-800 dark:text-brand-200 mb-4 text-lg">
              <i data-lucide="message-circle" class="w-5 h-5"></i>
              明日使える「一言」
            </h3>
            <ul id="resMagic" class="space-y-3"></ul>
          </div>

          <!-- Link to Brand Note -->
          <div class="bg-slate-100/50 dark:bg-slate-800/30 p-5 rounded-2xl border border-slate-200 dark:border-slate-700/60 text-center">
            <p class="text-xs text-slate-500 dark:text-slate-400 mb-3 font-medium">
              迷いが深いときは「軸」に戻ると、言葉が整います。<br>
              Brand Noteを確認して、もう一度試してみましょう。
            </p>
            <a href="https://spc-jp.github.io/bs-brand-note/" target="_blank" rel="noopener"
                 class="text-xs font-black text-brand-600 dark:text-brand-300 hover:underline inline-flex items-center gap-1.5 py-2 px-4 rounded-full bg-white dark:bg-slate-800 shadow-sm border border-slate-200 dark:border-slate-700 transition hover:text-brand-700">
                <i data-lucide="book-open" class="w-3.5 h-3.5"></i>
                Brand Note を開く
                <i data-lucide="external-link" class="w-3 h-3 text-slate-400"></i>
            </a>
          </div>

        </div>

      </div>
    </div>
  </div>

  <!-- CONFIRM MODAL -->
  <div id="confirmModal" class="fixed inset-0 z-[70] hidden">
    <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="closeConfirmModal()"></div>
    <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-11/12 max-w-xs bg-white dark:bg-slate-800 rounded-2xl shadow-2xl p-6 text-center space-y-4 animate-pop">
      <div class="w-12 h-12 bg-red-100 dark:bg-red-900/30 text-red-500 rounded-full flex items-center justify-center mx-auto">
        <i data-lucide="alert-triangle" class="w-6 h-6"></i>
      </div>
      <div>
        <div class="font-black text-slate-800 dark:text-white text-lg">削除しますか？</div>
        <p id="confirmMessage" class="text-xs text-slate-500 dark:text-slate-400 mt-1">この操作は元に戻せません。</p>
      </div>
      <div class="grid grid-cols-2 gap-3">
        <button onclick="closeConfirmModal()" class="py-2.5 rounded-xl font-bold text-slate-500 hover:bg-slate-100 dark:text-slate-300 dark:hover:bg-slate-700 transition text-sm">
          キャンセル
        </button>
        <button onclick="executeDelete()" class="py-2.5 rounded-xl font-bold bg-red-500 text-white hover:bg-red-600 shadow-lg shadow-red-500/30 transition text-sm">
          削除する
        </button>
      </div>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <nav class="fixed bottom-0 w-full bg-white/90 dark:bg-slate-900/90 backdrop-blur-lg border-t border-slate-200 dark:border-slate-800 pb-safe z-40 transition-colors duration-300">
    <div class="max-w-5xl mx-auto grid grid-cols-3 h-16">
      <button onclick="switchTab('home')" class="nav-btn group flex flex-col items-center justify-center gap-1 text-brand-600 dark:text-brand-300" data-target="home">
        <div class="p-1 rounded-full group-active:bg-slate-100 dark:group-active:bg-slate-800 transition-colors">
          <i data-lucide="sparkles" class="w-6 h-6 group-active:scale-90 transition-transform"></i>
        </div>
        <span class="text-[10px] font-black">診断</span>
      </button>
      <button onclick="switchTab('history')" class="nav-btn group flex flex-col items-center justify-center gap-1 text-slate-400 dark:text-slate-500 hover:text-slate-600 dark:hover:text-slate-300" data-target="history">
        <div class="p-1 rounded-full group-active:bg-slate-100 dark:group-active:bg-slate-800 transition-colors">
          <i data-lucide="history" class="w-6 h-6 group-active:scale-90 transition-transform"></i>
        </div>
        <span class="text-[10px] font-black">履歴</span>
      </button>
      <button onclick="switchTab('favorites')" class="nav-btn group flex flex-col items-center justify-center gap-1 text-slate-400 dark:text-slate-500 hover:text-slate-600 dark:hover:text-slate-300" data-target="favorites">
        <div class="p-1 rounded-full group-active:bg-slate-100 dark:group-active:bg-slate-800 transition-colors">
          <i data-lucide="bookmark" class="w-6 h-6 group-active:scale-90 transition-transform"></i>
        </div>
        <span class="text-[10px] font-black">保存済</span>
      </button>
    </div>
  </nav>

  <script>
    const BRAND_NOTE_URL = "https://spc-jp.github.io/bs-brand-note/";
    const BOSS_SCENES = [
      { id: 'morning', label: '朝礼' },
      { id: 'oneonone', label: '1on1' },
      { id: 'request', label: '依頼' },
      { id: 'point', label: '指摘' },
      { id: 'afterfail', label: '失敗後' },
      { id: 'thanks', label: '感謝' },
    ];

    // Default Boss Voice Data (Fallback)
    const commonBossVoices = {
      new: {
        morning: ["今日も一つ、新しい挑戦をしてみよう。", "困ったらすぐに声をかけてね。", "失敗を恐れずに、まずは行動量で勝負！"],
        oneonone: ["最近、仕事でワクワクした瞬間はあった？", "何でも話していいよ。君の成長が一番大事。", "無理してない？ペース配分も仕事のうちだよ。"],
        request: ["この仕事、君の新しい強みになると思うんだ。", "まずは60点の出来でいいから見せて。", "君だから頼みたい。一緒に進めよう。"],
        point: ["ここはもっと良くできる。一緒に考えよう。", "結果よりプロセスを見直そう。", "次はどうすれば防げるか、アイデアある？"],
        afterfail: ["ナイスチャレンジ！次に活かせば成功の種。", "命までは取られない。大丈夫。", "原因だけ特定して、あとは切り替えよう。"],
        thanks: ["君のおかげで助かったよ、ありがとう。", "その気配り、すごくいいね。", "君の成長が見えて嬉しいよ。"]
      },
      mid: {
        morning: ["チーム全体を見る視点を意識してみよう。", "今日はメンバーの表情をよく見てあげて。", "数字の裏にある顧客の感情を想像しよう。"],
        oneonone: ["チームの課題、君はどう捉えてる？", "君がリーダーならどう決断する？", "もっと任せたい。君の背中を見せてほしい。"],
        request: ["このプロジェクト、君に裁量を預けたい。", "全体最適の視点で判断して進めてみて。", "君なりの付加価値を期待してるよ。"],
        point: ["視座をもう一段上げてみよう。", "メンバーへの影響力を意識してる？", "論理と感情、両方のバランスが大事だ。"],
        afterfail: ["責任は私が取る。君は対策をリードして。", "この経験をチームの資産に変えよう。", "リーダーとしての器が試される時だね。"],
        thanks: ["頼りにしてるよ。さすがだね。", "チームを支えてくれてありがとう。", "君の存在が組織の安定剤だ。"]
      }
    };

    // Helper to merge default and specific voices
    function createBossVoice(overrides = {}) {
      const merged = JSON.parse(JSON.stringify(commonBossVoices)); // deep clone
      
      // overrides structure: { new: { scene: [] }, mid: { scene: [] } }
      if (overrides.new) {
        Object.keys(overrides.new).forEach(scene => {
          if (merged.new[scene]) merged.new[scene] = overrides.new[scene];
        });
      }
      if (overrides.mid) {
        Object.keys(overrides.mid).forEach(scene => {
          if (merged.mid[scene]) merged.mid[scene] = overrides.mid[scene];
        });
      }
      return merged;
    }

    // Data Definitions
    const cases = [
      {
        id: "task-only",
        title: "指示待ちロボット型",
        badge: "CASE: 指示待ち",
        proverb: "仕事を終わらせるだけで止まらない。広げて返せる人が伸びる。",
        explain: "言われたことだけに収まると安心ですが、成長が止まります。小さな工夫を一つ足すだけで、仕事は価値になります。",
        magic: [
          "この作業、言われた範囲にあなたなりの工夫を一つ足してみて🙂",
          "完了報告じゃなくて、次に何をやるべきかまで提案してみよう",
          "もしあなたが担当リーダーなら、次の一手は何にする？"
        ],
        bossVoice: createBossVoice({
          new: {
            request: ["言われた通り＋1%の工夫を期待してるよ。", "正解じゃなくていい、君の考えを乗せてみて。", "完了したら『次はこれやりますか？』と聞いてみて。"]
          },
          mid: {
            request: ["指示を待つな。君が動けばチームが動く。", "このタスクの『真の目的』を考えて動いて。", "君からの提案がないと、組織は停滞するよ。"]
          }
        })
      },
      {
        id: "no-decision",
        title: "判断丸投げ型",
        badge: "CASE: 判断丸投げ",
        proverb: "判断を預けるクセは、信頼とチャンスも手放している。",
        explain: "失敗が怖いと人は決められません。まずは自分の推しを言えるようにするだけで、成長が始まります。",
        magic: [
          "まずあなたのベスト案を一つ決めてから相談してみて",
          "今回はあなたの判断で決めていい。責任は背負うよ",
          "A案とB案、それぞれの最悪のケースを一度想像しよう"
        ],
        bossVoice: createBossVoice({
          new: {
            point: ["間違ってもいい。自分で決める練習だよ。", "どっちが好きか、直感でもいいから教えて。", "君の選択をサポートするから大丈夫。"]
          },
          mid: {
            point: ["君が決断しないと、現場が迷うよ。", "リスクを取るのがリーダーの仕事だ。", "私の顔色より、顧客の顔を見て決めて。"]
          }
        })
      },
      {
        id: "solo-play",
        title: "抱え込みソロプレイヤー",
        badge: "CASE: 抱え込み",
        proverb: "一人で抱えない。チームで前に進むのがプロの仕事。",
        explain: "真面目な人ほど背負います。頼ることは弱さではなく、速度を上げる作戦です。",
        magic: [
          "誰を巻き込むと最速になる？を先に考えてみよう",
          "後輩に任せられる部分を切り出すのも大事な仕事だよ",
          "助けを求めるのは弱さじゃなくて状況判断だよ🙂"
        ],
        bossVoice: createBossVoice({
          new: {
            oneonone: ["SOS出しも立派なスキルだよ。", "一人で100点より、みんなで120点を目指そう。", "辛くなる前に、旗を振ってね。"]
          },
          mid: {
            oneonone: ["君が抱え込むと、後輩が育つ機会を奪うよ。", "チームで成果を出すことにシフトしよう。", "属人化させない仕組みを作ってほしい。"]
          }
        })
      },
      {
        id: "status-quo",
        title: "現状維持バイアス型",
        badge: "CASE: 現状維持",
        proverb: "現状維持は、少しずつ後退しているのと同じ。",
        explain: "変化が怖いと止まります。全部変えないでいい。小さな実験で前に進めます。",
        magic: [
          "1週間だけ試すなら、どこを少し変えられる？",
          "失敗しても戻せる小実験でいこう",
          "変わらないリスクと変わるリスク、どっちが大きい？"
        ],
        bossVoice: createBossVoice({
          new: {
            morning: ["昨日と同じやり方を、一つだけ変えてみよう。", "新しいツール、どんどん試していいよ。", "変化を楽しめる人が一番強いんだ。"]
          },
          mid: {
            morning: ["前例踏襲は禁止。ゼロベースで考えて。", "販売管理のその先を作るのが君の役目だ。", "安定より挑戦。失敗は学習コストだ。"]
          }
        })
      },
      {
        id: "no-consult",
        title: "相談なしで独走型",
        badge: "CASE: ホウレンソウ不足",
        proverb: "相談は弱さじゃない。ズレを早く直すための測量。",
        explain: "相談が遅いと手戻りが増えます。途中の骨組みを見せる文化にすると改善します。",
        magic: [
          "完成じゃなくて骨組みの段階で見せてくれる？",
          "5分でいいから方向だけ合わせよう",
          "報告じゃなくて作戦会議だと思って気軽に🙂"
        ],
        bossVoice: createBossVoice({
          new: {
            point: ["走る前に、地図合わせだけしよう。", "君の熱意は買う。ただ方向だけ確認させて。", "報告は『義務』じゃなくて『作戦会議』だよ。"]
          },
          mid: {
            point: ["組織で動く以上、独断はリスクだ。", "共有がないと、君を守りきれなくなる。", "スピードと独走は違う。周囲を巻き込んで。"]
          }
        })
      },
      {
        id: "silent",
        title: "指摘でフリーズ型",
        badge: "CASE: 指摘で沈黙",
        proverb: "フィードバックは攻撃じゃない。一緒に上げる攻略本。",
        explain: "黙るのは防御反応です。敵じゃないよを先に伝えると、言葉が出やすくなります。",
        magic: [
          "責めてないよ。もっと良くする作戦会議だよ",
          "まず今どう感じたか、一言だけ教えて🙂",
          "原因より、これからどうするかに集中しよう"
        ],
        bossVoice: createBossVoice({
          new: {
            point: ["怒ってるわけじゃない。君に期待してるんだ。", "深呼吸して。思ったこと、そのまま言っていいよ。", "言葉に詰まったら『考え中です』でOK。"]
          },
          mid: {
            point: ["沈黙は解決にならない。言葉で戦って。", "君の意見を聞きたい。反論でも大歓迎だ。", "感情を横に置いて、事実だけで話そう。"]
          }
        })
      },
      {
        id: "late-report",
        title: "悪い報告が遅れる型",
        badge: "CASE: 報告遅れ",
        proverb: "報告が早い人は、失敗じゃなく選択肢を増やしている。",
        explain: "解決してなくても事実が早いほど打てる手が増えます。早いバッドニュースを評価する文化が特効薬です。",
        magic: [
          "解決してなくていい。状況だけ最速で教えて",
          "困ったときに早く言った人が得するルールにしよう",
          "怒らない。事実だけを淡々と教えて🙂"
        ],
        bossVoice: createBossVoice({
          new: {
            afterfail: ["早く言ってくれてありがとう。それが一番大事。", "隠すのが一番の失敗だよ。", "バッドニュース・ファースト。次はもっと早くね。"]
          },
          mid: {
            afterfail: ["火種は小さいうちに消す。それがプロだ。", "報告の遅れは、経営判断を誤らせるよ。", "信頼残高は、報告のスピードで決まる。"]
          }
        })
      },
      {
        id: "critic",
        title: "口だけ評論家型",
        badge: "CASE: 評論家",
        proverb: "批評より、一歩の提案。舞台に上がる人が前に進める。",
        explain: "指摘は価値になりません。代案と最初の一歩までがセットになると、チームが動きます。",
        magic: [
          "鋭いね。最初の一歩は何にする？",
          "あなたがリーダーなら、誰を巻き込む？",
          "できない理由じゃなく、できる形を一緒に🙂"
        ],
        bossVoice: createBossVoice({
          mid: {
            request: ["分析は十分。で、君ならどう動かす？", "評論家はいらない。実務家であれ。", "汗をかかない提案には、誰もついてこないよ。"]
          }
        })
      },
      {
        id: "busy-word",
        title: "忙しいが口癖型",
        badge: "CASE: 忙しい",
        proverb: "忙しいは状態。優先順位は技術。",
        explain: "見えないから焦ります。全部書き出して、今やる3つに絞るだけで進みます。",
        magic: [
          "今日やること全部書いて、今やる3つだけ選ぼう",
          "やらないことを決めよう。戦略だよ",
          "60点でいいから一度見せて🙂"
        ],
        bossVoice: createBossVoice({
          new: {
            oneonone: ["全部やる必要ないよ。大事なのはどれ？", "忙しい時ほど、深呼吸して一つずつ。", "断る勇気も教えていきたい。"]
          },
          mid: {
            oneonone: ["『忙しい』は思考停止のサインだ。", "やらないことを決めるのが戦略だよ。", "君の時間単価に見合う仕事に集中して。"]
          }
        })
      },
      {
        id: "perfectionist",
        title: "完璧主義で遅い型",
        badge: "CASE: 完璧主義",
        proverb: "70点の早い提出は、100点の遅刻より価値がある。",
        explain: "品質には納期も含まれます。まず骨組みを出すクセを付けると、仕事が回り始めます。",
        magic: [
          "30点でいい。骨組みだけ今見せて",
          "削るならどこを削る？を決めよう",
          "走りながら直そう。修正は後から🙂"
        ],
        bossVoice: createBossVoice({
          new: {
            request: ["荒削りでいい。スピードが熱量だよ。", "悩み始めたら、そこで一度見せて。", "完璧主義より、完了主義でいこう。"]
          },
          mid: {
            request: ["ビジネスにおける品質は、スピードとの掛け算だ。", "100点を目指して機会を逃すな。", "プロトタイプを回して修正する。それが今の流儀だ。"]
          }
        })
      },
      {
        id: "chicken-heart",
        title: "失敗が怖くて動けない型",
        badge: "CASE: 失敗恐怖",
        proverb: "失敗は行き止まりじゃない。正解への通過点。",
        explain: "失敗＝悪の思い込みがブレーキになります。挑戦した事実を評価するだけで動けます。",
        magic: [
          "失敗しても一緒に謝る。大丈夫",
          "結果より、挑戦した事実を褒めたい",
          "一番のリスクは、動かないことだよ🙂"
        ],
        bossVoice: createBossVoice({
          new: {
            afterfail: ["ナイス転倒！前に転んだ証拠だ。", "この失敗は、君の成長の糧になる。", "どんどん失敗しろ。会社が受け止める。"]
          },
          mid: {
            afterfail: ["安全策ばかりでは、未来は作れない。", "リスクテイクした結果なら、私は評価する。", "守りに入ったら終わりだ。攻め続けろ。"]
          }
        })
      }
    ];

    // State Management
    let state = {
      history: JSON.parse(localStorage.getItem('bs_hitokoto_history')) || [],
      favorites: JSON.parse(localStorage.getItem('bs_hitokoto_favs')) || [],
      currentResult: null,
      currentBossScene: 'morning'
    };

    let pendingDelete = null;

    // --- Context & LocalStorage ---

    function safeGetContext() {
      const el = document.getElementById('companyContext');
      return (el && el.value) ? el.value.trim() : '';
    }

    function bsPrefix() {
      // BSモードは常にON
      return "BS前提: 販売管理は入口。データから新サービス共創につなげる。採用と育成は会社の未来。";
    }

    window.saveContext = function() {
      const ctx = safeGetContext();
      localStorage.setItem('bs_company_context', ctx);
      toast("保存しました🙂");
    };

    function loadContext() {
      const saved = localStorage.getItem('bs_company_context');
      const el = document.getElementById('companyContext');
      if (el && saved) el.value = saved;
    }

    function toast(msg) {
      const div = document.createElement('div');
      div.className = "fixed top-20 left-1/2 -translate-x-1/2 z-[80] px-5 py-2.5 rounded-full bg-slate-900/90 dark:bg-white/90 text-white dark:text-slate-900 text-xs font-black shadow-xl backdrop-blur-sm animate-fadeIn";
      div.innerHTML = `<span class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check"><path d="M20 6 9 17l-5-5"/></svg>${msg}</span>`;
      document.body.appendChild(div);
      setTimeout(() => { div.remove(); }, 1800);
    }

    // --- UI Actions ---

    window.toggleTheme = function() {
      const isDark = document.documentElement.classList.toggle('dark');
      localStorage.theme = isDark ? 'dark' : 'light';
      lucide.createIcons();
    };

    window.openGuide = function() {
      const modal = document.getElementById('guideModal');
      const panel = document.getElementById('guidePanel');
      modal.classList.remove('hidden');
      setTimeout(() => {
        panel.classList.remove('scale-95');
        panel.classList.add('scale-100');
      }, 10);
    };

    window.closeGuide = function() {
      const modal = document.getElementById('guideModal');
      const panel = document.getElementById('guidePanel');
      panel.classList.remove('scale-100');
      panel.classList.add('scale-95');
      setTimeout(() => modal.classList.add('hidden'), 200);
    };

    window.switchTab = function(targetId) {
      const navBtns = document.querySelectorAll('.nav-btn');
      const tabs = document.querySelectorAll('.tab-content');

      navBtns.forEach(btn => {
        if(btn.dataset.target === targetId) {
          btn.classList.add('text-brand-600', 'dark:text-brand-300');
          btn.classList.remove('text-slate-400', 'dark:text-slate-500');
        } else {
          btn.classList.remove('text-brand-600', 'dark:text-brand-300');
          btn.classList.add('text-slate-400', 'dark:text-slate-500');
        }
      });

      tabs.forEach(tab => {
        if(tab.id === `tab-${targetId}`) {
          tab.classList.remove('hidden');
          tab.classList.add('animate-fadeIn');
        } else {
          tab.classList.add('hidden');
          tab.classList.remove('animate-fadeIn');
        }
      });

      const mainContainer = document.getElementById('mainContainer');
      if(mainContainer) mainContainer.scrollTop = 0;
      lucide.createIcons();
    };

    window.clearError = function() {
      const qBehavior = document.getElementById('behavior');
      const errorMsg = document.getElementById('errorMsg');
      qBehavior.classList.remove('input-error');
      errorMsg.classList.add('hidden');
    };

    // --- Diagnosis Logic ---

    function shuffleArray(array) {
      const newArr = [...array];
      for (let i = newArr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [newArr[i], newArr[j]] = [newArr[j], newArr[i]];
      }
      return newArr;
    }

    window.runDiagnosis = function() {
      const qBehavior = document.getElementById('behavior');
      const errorMsg = document.getElementById('errorMsg');
      const behaviorVal = qBehavior ? qBehavior.value : null;

      if (!behaviorVal || behaviorVal === "") {
        qBehavior.classList.add('input-error');
        qBehavior.focus();
        errorMsg.classList.remove('hidden');
        if (navigator.vibrate) navigator.vibrate(50);
        return;
      }

      let levelVal = 'new';
      const levels = document.getElementsByName('level');
      levels.forEach(r => { if(r.checked) levelVal = r.value; });

      const resultData = cases.find(c => c.id === behaviorVal);
      if (!resultData) return;

      const btn = document.getElementById('diagnoseBtn');
      const textNormal = btn.querySelector('.text-normal');
      const textLoading = btn.querySelector('.text-loading');
      const iconNormal = btn.querySelector('.icon-normal');

      btn.disabled = true;
      textNormal.classList.add('hidden');
      textLoading.classList.remove('hidden');
      iconNormal.classList.add('hidden');

      setTimeout(() => {
        const ctx = safeGetContext();
        const prefix = bsPrefix();
        
        let fullContext = "";
        if (prefix) fullContext += prefix;
        if (prefix && ctx) fullContext += "\n";
        if (ctx) fullContext += "会社の前提: " + ctx;

        const shuffledMagic = shuffleArray(resultData.magic);

        state.currentResult = {
          ...resultData,
          level: levelVal,
          context: fullContext,
          magicShuffled: shuffledMagic,
          timestamp: new Date().toISOString()
        };

        // Reset scene to morning for new result
        state.currentBossScene = 'morning';

        addToHistory(state.currentResult);
        populateResult(state.currentResult);
        openModal();

        btn.disabled = false;
        textNormal.classList.remove('hidden');
        textLoading.classList.add('hidden');
        iconNormal.classList.remove('hidden');
      }, 800);
    };

    window.populateResult = function(data) {
      const badgeLabel = data.level === 'mid' ? 'LEADER TYPE' : 'ROOKIE TYPE';
      const explainTitle = data.level === 'mid' ? '中堅・リーダーへの処方箋' : '新人・若手への処方箋';

      document.getElementById('resBadge').textContent = badgeLabel + " : " + data.badge.replace("CASE: ", "");
      document.getElementById('resProverb').textContent = data.proverb;
      
      document.getElementById('resExplain').textContent = data.explain;
      document.getElementById('resExplainTitle').textContent = explainTitle;

      const contextBox = document.getElementById('resContextBox');
      const contextText = document.getElementById('resContextText');
      if (data.context && data.context.trim() !== "") {
        contextBox.classList.remove('hidden');
        contextText.textContent = data.context;
      } else {
        contextBox.classList.add('hidden');
      }

      // --- Boss Voice Rendering ---
      renderBossVoiceUI(data);

      // --- Magic Words Rendering ---
      const magicList = document.getElementById('resMagic');
      const iconName = data.level === 'mid' ? 'star' : 'check-circle-2';
      const magicToUse = data.magicShuffled || data.magic;

      magicList.innerHTML = magicToUse.map(m => `
        <li class="flex items-start gap-3 bg-white dark:bg-slate-800 p-3.5 rounded-xl text-sm text-slate-700 dark:text-slate-200 shadow-sm border border-slate-100 dark:border-slate-700">
          <i data-lucide="${iconName}" class="w-5 h-5 text-emerald-500 shrink-0 mt-0.5"></i>
          <span class="font-medium">${m}</span>
        </li>
      `).join('');

      lucide.createIcons({ root: document.getElementById('resultPanel') });
      updateFavBtnState();
    };

    window.renderBossVoiceUI = function(data) {
      const tabsContainer = document.getElementById('bossSceneTabs');
      const voiceList = document.getElementById('resBossVoice');

      // 1. Render Tabs
      tabsContainer.innerHTML = BOSS_SCENES.map(scene => {
        const isActive = scene.id === state.currentBossScene;
        return `
          <button onclick="switchBossScene('${scene.id}')" 
            class="scene-tab px-3 py-1.5 rounded-full text-[11px] font-bold border transition-colors ${
              isActive 
              ? 'active' 
              : 'bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 text-slate-500 dark:text-slate-400 hover:border-brand-300 dark:hover:border-slate-600'
            }">
            ${scene.label}
          </button>
        `;
      }).join('');

      // 2. Render List Content
      const voiceData = data.bossVoice || commonBossVoices; // Fallback to common if no override (rare case)
      const voicesByLevel = voiceData[data.level] || commonBossVoices[data.level];
      const voices = voicesByLevel[state.currentBossScene] || [];

      voiceList.innerHTML = voices.map(v => `
        <li class="flex items-start gap-2.5 text-xs text-slate-600 dark:text-slate-300 bg-white/50 dark:bg-slate-700/50 p-2.5 rounded-lg border border-slate-100 dark:border-slate-600/50">
           <i data-lucide="message-square" class="w-3.5 h-3.5 text-slate-400 mt-0.5 shrink-0"></i>
           <span>${v}</span>
        </li>
      `).join('');
    };

    window.switchBossScene = function(sceneId) {
      state.currentBossScene = sceneId;
      // Re-render UI with new state
      if(state.currentResult) {
        // Only update Boss UI to avoid flickering entire modal
        renderBossVoiceUI(state.currentResult);
        lucide.createIcons({ root: document.getElementById('bossSceneTabs').parentNode });
      }
    };

    window.openModal = function() {
      const modal = document.getElementById('resultModal');
      const backdrop = document.getElementById('resultBackdrop');
      const panel = document.getElementById('resultPanel');

      modal.classList.remove('hidden');
      document.body.classList.add('modal-open');

      setTimeout(() => {
        backdrop.classList.remove('opacity-0');
        panel.classList.remove('scale-95', 'opacity-0');
        panel.classList.add('scale-100', 'opacity-100');
      }, 10);
    };

    window.closeModal = function() {
      const modal = document.getElementById('resultModal');
      const backdrop = document.getElementById('resultBackdrop');
      const panel = document.getElementById('resultPanel');

      backdrop.classList.add('opacity-0');
      panel.classList.remove('scale-100', 'opacity-100');
      panel.classList.add('scale-95', 'opacity-0');

      document.body.classList.remove('modal-open');
      setTimeout(() => modal.classList.add('hidden'), 260);
    };

    // --- History & Favorites ---

    function addToHistory(item) {
      const existingIdx = state.history.findIndex(h => h.id === item.id && h.level === item.level);
      if (existingIdx !== -1) state.history.splice(existingIdx, 1);

      state.history.unshift(item);
      if (state.history.length > 20) state.history.pop();

      localStorage.setItem('bs_hitokoto_history', JSON.stringify(state.history));
      renderHistory();
    }

    function renderHistory() {
      const historyList = document.getElementById('historyList');
      const teaserList = document.getElementById('teaserList');
      const homeHistoryTeaser = document.getElementById('homeHistoryTeaser');

      let html = '';
      if (state.history.length > 0) {
        html = state.history.map((item, idx) => createItemHTML(item, idx, 'history')).join('');
        html += `
          <div class="pt-6 pb-2 flex justify-center col-span-full">
            <button onclick="confirmDelete('all_history')" class="text-xs font-bold text-red-400 hover:text-red-600 transition flex items-center gap-1.5 py-2 px-4 rounded-full hover:bg-red-50 dark:hover:bg-red-900/20">
              <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
              履歴をすべて削除
            </button>
          </div>
        `;
      } else {
        html = `
          <div class="text-center py-20 opacity-60 flex flex-col items-center gap-4 col-span-full">
            <div class="w-20 h-20 bg-slate-100 dark:bg-slate-800 rounded-full flex items-center justify-center text-slate-300 dark:text-slate-600">
              <i data-lucide="history" class="w-10 h-10"></i>
            </div>
            <p class="text-sm font-black text-slate-400 dark:text-slate-500">まだ履歴はありません</p>
          </div>
        `;
      }

      historyList.innerHTML = html;

      if (state.history.length > 0) {
        homeHistoryTeaser.classList.remove('hidden');
        teaserList.innerHTML = state.history.slice(0, 3).map((item, idx) => createItemHTML(item, idx, 'teaser')).join('');
      } else {
        homeHistoryTeaser.classList.add('hidden');
      }

      lucide.createIcons({ root: historyList });
      lucide.createIcons({ root: teaserList });
    }

    function renderFavorites() {
      const favList = document.getElementById('favList');
      let html = '';

      if (state.favorites.length > 0) {
        html = state.favorites.map((item, idx) => createItemHTML(item, idx, 'fav')).join('');
        html += `
          <div class="pt-6 pb-2 flex justify-center col-span-full">
            <button onclick="confirmDelete('all_fav')" class="text-xs font-bold text-red-400 hover:text-red-600 transition flex items-center gap-1.5 py-2 px-4 rounded-full hover:bg-red-50 dark:hover:bg-red-900/20">
              <i data-lucide="trash-2" class="w-3.5 h-3.5"></i>
              保存済をすべて削除
            </button>
          </div>
        `;
      } else {
        html = `
          <div class="text-center py-20 opacity-60 flex flex-col items-center gap-4 col-span-full">
            <div class="w-20 h-20 bg-slate-100 dark:bg-slate-800 rounded-full flex items-center justify-center text-slate-300 dark:text-slate-600">
              <i data-lucide="bookmark" class="w-10 h-10"></i>
            </div>
            <p class="text-sm font-black text-slate-400 dark:text-slate-500">保存済は空です</p>
            <p class="text-xs text-slate-400">「保存」した処方箋がここにたまります</p>
          </div>
        `;
      }

      favList.innerHTML = html;
      lucide.createIcons({ root: favList });
    }

    function createItemHTML(item, idx, type) {
      const date = item.timestamp ? new Date(item.timestamp).toLocaleDateString() : 'Now';
      const isTeaser = type === 'teaser';
      const levelIcon = item.level === 'mid' ? '🦅' : '🐣';
      const levelText = item.level === 'mid' ? '中堅' : '新人';

      if (isTeaser) {
        return `
          <div onclick="openItem('${item.id}', '${item.level}')" class="bg-white dark:bg-slate-800 p-3.5 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 flex items-center justify-between cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-700 transition active:scale-[0.98]">
            <div class="flex items-center gap-3 overflow-hidden">
              <div class="w-10 h-10 rounded-full bg-brand-50 dark:bg-brand-900/30 text-brand-600 dark:text-brand-300 flex items-center justify-center shrink-0 font-black text-lg border border-brand-100 dark:border-transparent">${levelIcon}</div>
              <div class="min-w-0">
                <div class="text-sm font-black text-slate-700 dark:text-slate-200 truncate">${item.title}</div>
                <div class="text-xs text-slate-400 truncate">${date}</div>
              </div>
            </div>
          </div>
        `;
      }

      const delFn = type === 'history' ? `confirmDelete('history', ${idx})` : `confirmDelete('fav', ${idx})`;
      return `
        <div class="group relative bg-white dark:bg-slate-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden transition-all hover:shadow-md">
          <div onclick="openItem('${item.id}', '${item.level}')" class="p-4 pr-14 flex items-center gap-3.5 cursor-pointer active:bg-slate-50 dark:active:bg-slate-700">
            <div class="w-12 h-12 rounded-full bg-brand-50 dark:bg-brand-900/30 text-brand-600 dark:text-brand-300 flex items-center justify-center shrink-0 font-black text-xl border border-brand-100 dark:border-transparent">${levelIcon}</div>
            <div class="min-w-0">
              <div class="text-sm font-black text-slate-700 dark:text-slate-200 truncate mb-0.5">${item.title}</div>
              <div class="text-xs text-slate-400 truncate font-medium">${date} ・ ${levelText}</div>
            </div>
          </div>
          <button onclick="${delFn}" class="absolute right-0 top-0 bottom-0 w-14 flex items-center justify-center text-slate-300 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors z-10" aria-label="削除">
            <i data-lucide="trash-2" class="w-5 h-5"></i>
          </button>
        </div>
      `;
    }

    window.openItem = function(id, level = 'new') {
      // Find from history first if possible to get correct context/timestamp, else clean data
      const historyItem = state.history.find(h => h.id === id && h.level === level);
      const favItem = state.favorites.find(f => f.id === id && f.level === level);
      const rawItem = cases.find(c => c.id === id);

      // Prefer history/fav item to show saved context
      const itemToUse = historyItem || favItem || { ...rawItem, level: level, magicShuffled: rawItem.magic };
      
      // If raw item, ensure shuffling exists if not saved
      if (!itemToUse.magicShuffled && rawItem) {
         itemToUse.magicShuffled = rawItem.magic;
      }

      state.currentResult = itemToUse;
      populateResult(state.currentResult);
      openModal();
    };

    window.confirmDelete = function(type, index = null) {
      pendingDelete = { type, index };
      const modal = document.getElementById('confirmModal');
      const message = document.getElementById('confirmMessage');

      if (type === 'all_history') message.textContent = "診断履歴をすべて削除しますか？";
      else if (type === 'all_fav') message.textContent = "保存済をすべて削除しますか？";
      else message.textContent = "この項目を削除しますか？";

      modal.classList.remove('hidden');
    };

    window.closeConfirmModal = function() {
      document.getElementById('confirmModal').classList.add('hidden');
      pendingDelete = null;
    };

    window.executeDelete = function() {
      if(!pendingDelete) return;

      if (pendingDelete.type === 'history' && pendingDelete.index !== null) {
        state.history.splice(pendingDelete.index, 1);
        localStorage.setItem('bs_hitokoto_history', JSON.stringify(state.history));
        renderHistory();
      } else if (pendingDelete.type === 'fav' && pendingDelete.index !== null) {
        state.favorites.splice(pendingDelete.index, 1);
        localStorage.setItem('bs_hitokoto_favs', JSON.stringify(state.favorites));
        renderFavorites();
        updateFavBtnState();
      } else if (pendingDelete.type === 'all_history') {
        state.history = [];
        localStorage.removeItem('bs_hitokoto_history');
        renderHistory();
      } else if (pendingDelete.type === 'all_fav') {
        state.favorites = [];
        localStorage.removeItem('bs_hitokoto_favs');
        renderFavorites();
        updateFavBtnState();
      }

      closeConfirmModal();
    };

    window.toggleCurrentFav = function() {
      if(!state.currentResult) return;

      const idx = state.favorites.findIndex(f => f.id === state.currentResult.id && f.level === state.currentResult.level);
      if (idx >= 0) state.favorites.splice(idx, 1);
      else state.favorites.unshift(state.currentResult);

      localStorage.setItem('bs_hitokoto_favs', JSON.stringify(state.favorites));
      updateFavBtnState();
      renderFavorites();
    };

    window.updateFavBtnState = function() {
      const saveFavBtn = document.getElementById('saveFavBtn');
      if(!state.currentResult || !saveFavBtn) return;

      const isFav = state.favorites.some(f => f.id === state.currentResult.id && f.level === state.currentResult.level);
      const icon = saveFavBtn.querySelector('i');
      const text = saveFavBtn.querySelector('span');

      if(isFav) {
        saveFavBtn.classList.add('bg-brand-50', 'text-brand-700', 'border-brand-200');
        if(icon) icon.setAttribute('fill', 'currentColor');
        if(text) text.textContent = "保存済";
      } else {
        saveFavBtn.classList.remove('bg-brand-50', 'text-brand-700', 'border-brand-200');
        if(icon) icon.setAttribute('fill', 'none');
        if(text) text.textContent = "保存";
      }

      lucide.createIcons({ root: saveFavBtn });
    };

    window.shareResult = async function() {
      if(!state.currentResult) return;

      const ctxText = state.currentResult.context ? "（前提あり）" : "";
      const text =
        `【${state.currentResult.title}】への処方箋\n` +
        `"${state.currentResult.proverb}"\n\n` +
        `Brand Noteで答え合わせ ${ctxText}\n` +
        `${BRAND_NOTE_URL}`;

      if (navigator.share) {
        try { await navigator.share({ title: 'BS Hitokoto', text: text, url: window.location.href }); } catch(e) {}
      } else {
        navigator.clipboard.writeText(text).then(() => toast("コピーしました🙂"));
      }
    };

    document.addEventListener("DOMContentLoaded", () => {
      if (window.lucide) lucide.createIcons();

      // Check system theme
      if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.classList.add('dark');
      }

      loadContext();
      renderHistory();
      renderFavorites();
    });
  </script>
</body>
</html>